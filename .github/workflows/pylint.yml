name: Pylint

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]
    steps:
    - uses: actions/checkout@v4
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v3
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pylint pylint-exit
        pip install -r requirements.txt
    
    - name: Create __init__.py files
      run: |
        # 创建必要的 __init__.py 文件，避免导入错误
        touch __init__.py
        find . -type d -not -path "*/\.*" -exec test -e {}/__init__.py -o -e {}/__init__.pyc \; -o -exec touch {}/__init__.py \;
    
    - name: Analysing the code with pylint
      continue-on-error: true  # 允许继续，即使 pylint 失败
      id: pylint
      run: |
        # 运行 pylint，生成输出文件
        pylint $(git ls-files '*.py') --output=pylint-report.txt --exit-zero || true
        # 显示报告
        cat pylint-report.txt
        # 计算得分
        SCORE=$(grep -oP 'rated at \K[0-9.]+' pylint-report.txt | head -1)
        echo "Pylint score: $SCORE/10"
        echo "score=$SCORE" >> $GITHUB_OUTPUT
    
    - name: Check score threshold
      run: |
        SCORE="${{ steps.pylint.outputs.score }}"
        if [ -z "$SCORE" ]; then
          echo "Could not extract score, but continuing"
          exit 0
        fi
        # 如果分数低于 7.0，标记为警告但不失败
        if (( $(echo "$SCORE < 79.0" | bc -l) )); then
          echo "⚠️ Pylint score is low: $SCORE/10"
          exit 0  # 不失败，只警告
        else
          echo "✅ Pylint score is good: $SCORE/10"
        fi
    
    - name: Upload pylint report
      uses: actions/upload-artifact@v3
      if: always()  # 即使失败也上传
      with:
        name: pylint-report-${{ matrix.python-version }}
        path: pylint-report.txt
